import { ZodiacSign, TimeFrame } from '../models/zodiac';

interface TopicMap {
  [key: string]: string[];
}

export class PseudoRandomHoroscopeGenerator {
  private topics: TopicMap;
  private conclusions: string[];
  private timeFactorWords: { [key in TimeFrame]: string[] };
  private zodiacTraits: { [key in ZodiacSign]: string[] };

  constructor() {
    this.topics = {
      "работа": [
        "На работе вас ждет успех. Сосредоточьтесь на главных задачах и не распыляйтесь на мелочи.",
        "Ваши коллеги оценят ваши идеи. Смело выражайте свои мысли и предложения.",
        "Профессиональная сфера потребует внимания. Есть вероятность получения интересного предложения.",
        "Рабочая обстановка сегодня благоприятна для новых начинаний. Не бойтесь экспериментировать.",
        "На работе могут возникнуть сложности, но вы справитесь с ними благодаря своей находчивости.",
        "Сегодня хороший день для профессионального роста. Обратите внимание на обучение новым навыкам.",
        "В рабочей сфере возможны перемены. Будьте готовы адаптироваться к новым условиям.",
        "Ваши трудовые достижения не останутся незамеченными. Вероятно поощрение или признание заслуг."
      ],
      "любовь": [
        "В любви вас ожидают приятные сюрпризы. Отношения с партнером станут теплее и гармоничнее.",
        "Романтические отношения будут радовать. Проявите внимание к потребностям вашего партнера.",
        "В личной жизни наступает период обновления. Освободитесь от старых обид и откройтесь новым чувствам.",
        "Любовная сфера потребует искренности. Честный разговор поможет укрепить отношения.",
        "Звезды советуют проявить больше романтики в отношениях. Маленькие знаки внимания укрепят связь.",
        "В личной жизни возможны важные решения. Доверьтесь своему сердцу, оно подскажет правильный путь.",
        "Любовь окрыляет вас. Используйте это вдохновение для творчества и новых начинаний.",
        "Отношения с близким человеком выходят на новый уровень. Не бойтесь проявлять свои чувства."
      ],
      "здоровье": [
        "Уделите внимание своему здоровью. Простые физические упражнения зарядят энергией на весь день.",
        "Организм нуждается в отдыхе. Найдите время для расслабления и восстановления сил.",
        "Энергетический потенциал высок. Направьте эту энергию на полезные дела и саморазвитие.",
        "Здоровье требует внимания. Пересмотрите свой режим питания и сна для лучшего самочувствия.",
        "Физическая активность принесет пользу. Даже небольшая прогулка улучшит настроение и здоровье.",
        "Берегите эмоциональное здоровье. Медитация и дыхательные практики помогут снять напряжение.",
        "Организм благодарен за заботу. Продолжайте придерживаться здорового образа жизни.",
        "Звезды советуют больше двигаться. Активность поможет поддержать тело и дух в хорошей форме."
      ],
      "финансы": [
        "Финансовая ситуация улучшится. Возможны неожиданные поступления или выгодные предложения.",
        "В денежных вопросах проявите осторожность. Не время для крупных и необдуманных трат.",
        "Финансовое положение стабильно. Можно планировать покупки, о которых вы давно мечтали.",
        "Денежные вопросы потребуют внимания. Пересмотрите свой бюджет и найдите способы экономии.",
        "Звезды благоприятствуют финансовым начинаниям. Хорошее время для инвестиций или бизнес-идей.",
        "В сфере финансов наступает период роста. Используйте это время для увеличения доходов.",
        "Материальное положение может измениться к лучшему. Будьте открыты новым возможностям заработка.",
        "Денежные вопросы решатся успешно. Доверьтесь своей интуиции в финансовых решениях."
      ],
      "общее": [
        "День принесет много радости. Наслаждайтесь каждым моментом и делитесь позитивом с окружающими.",
        "Период благоприятен для самопознания. Обратите внимание на свои истинные желания и потребности.",
        "Удача на вашей стороне. Смело двигайтесь к своим целям, преодолевая все препятствия.",
        "День будет наполнен приятными встречами. Общение с близкими по духу людьми принесет радость.",
        "Интуиция сейчас особенно сильна. Доверяйте своему внутреннему голосу в принятии решений.",
        "Перемены к лучшему уже близко. Будьте открыты новому опыту и возможностям.",
        "Энергия дня способствует творчеству. Выражайте себя через любимые занятия и хобби.",
        "Время расставить приоритеты. Сосредоточьтесь на том, что действительно важно для вас."
      ]
    };

    this.conclusions = [
      "Помните, что звезды дают советы, но выбор всегда за вами.",
      "Используйте энергию этого периода для личностного роста и самосовершенствования.",
      "Внимательно прислушивайтесь к своей интуиции, она не подведет.",
      "Позитивное мышление поможет привлечь в вашу жизнь больше счастья и удачи.",
      "Доверьтесь течению жизни, и она принесет вам то, что нужно именно сейчас.",
      "Будьте открыты новым возможностям, даже если они приходят неожиданно.",
      "Проявляйте больше благодарности за то, что имеете, и вселенная ответит щедростью.",
      "Не забывайте о балансе во всех сферах жизни - это ключ к гармонии и счастью."
    ];

    this.timeFactorWords = {
      [TimeFrame.TODAY]: ["сегодня", "этот день", "в течение дня"],
      [TimeFrame.TOMORROW]: ["завтра", "ближайшее будущее", "грядущий день"],
      [TimeFrame.WEEK]: ["на этой неделе", "ближайшие дни", "в течение недели"],
      [TimeFrame.MONTH]: ["в этом месяце", "ближайшие недели", "предстоящий период"]
    };

    this.zodiacTraits = {
      [ZodiacSign.ARIES]: ["энергия", "инициативность", "лидерство", "смелость", "энтузиазм"],
      [ZodiacSign.TAURUS]: ["стабильность", "терпение", "надежность", "практичность", "упорство"],
      [ZodiacSign.GEMINI]: ["общительность", "любознательность", "адаптивность", "интеллект", "разносторонность"],
      [ZodiacSign.CANCER]: ["интуиция", "забота", "эмоциональность", "домашний уют", "преданность"],
      [ZodiacSign.LEO]: ["творчество", "лидерство", "щедрость", "энтузиазм", "уверенность"],
      [ZodiacSign.VIRGO]: ["аналитичность", "практичность", "внимательность", "надежность", "организованность"],
      [ZodiacSign.LIBRA]: ["гармония", "справедливость", "дипломатичность", "сотрудничество", "эстетика"],
      [ZodiacSign.SCORPIO]: ["страсть", "решительность", "проницательность", "трансформация", "глубина"],
      [ZodiacSign.SAGITTARIUS]: ["оптимизм", "свобода", "философия", "приключения", "честность"],
      [ZodiacSign.CAPRICORN]: ["амбициозность", "дисциплина", "ответственность", "организованность", "терпение"],
      [ZodiacSign.AQUARIUS]: ["оригинальность", "независимость", "прогрессивность", "гуманность", "инновации"],
      [ZodiacSign.PISCES]: ["сострадание", "творчество", "интуиция", "духовность", "мечтательность"]
    };
  }

  private getSeed(): number {
    const today = new Date();
    return today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
  }

  private seededRandom(min: number, max: number, seed: number): number {
    const x = Math.sin(seed) * 10000;
    const result = (x - Math.floor(x)) * (max - min) + min;
    return Math.floor(result);
  }
  
  private seededChoice<T>(array: T[], seed: number): T {
    const index = this.seededRandom(0, array.length, seed);
    return array[index];
  }
  
  private seededSample<T>(array: T[], count: number, seed: number): T[] {
    const result: T[] = [];
    const arrayCopy = [...array];
    
    for (let i = 0; i < count && arrayCopy.length > 0; i++) {
      const index = this.seededRandom(0, arrayCopy.length, seed + i);
      result.push(arrayCopy[index]);
      arrayCopy.splice(index, 1);
    }
    
    return result;
  }
  
  private seededShuffle<T>(array: T[], seed: number): T[] {
    const arrayCopy = [...array];
    let currentIndex = arrayCopy.length;
    
    while (currentIndex !== 0) {
      const randomIndex = this.seededRandom(0, currentIndex, seed + currentIndex);
      currentIndex--;
      
      [arrayCopy[currentIndex], arrayCopy[randomIndex]] = 
      [arrayCopy[randomIndex], arrayCopy[currentIndex]];
    }
    
    return arrayCopy;
  }

  generatePrediction(sign: ZodiacSign, timeFrame: TimeFrame): string {
    const baseSeed = this.getSeed();
    const signValue = Object.values(ZodiacSign).indexOf(sign);
    const timeFrameValue = Object.values(TimeFrame).indexOf(timeFrame);
    const seed = baseSeed + signValue * 100 + timeFrameValue;
    
    const timeWord = this.seededChoice(this.timeFactorWords[timeFrame], seed);
    const trait = this.seededChoice(this.zodiacTraits[sign], seed + 1);
    
    const topicKeys = Object.keys(this.topics);
    const topicsToInclude = this.seededSample(
      topicKeys, 
      this.seededRandom(2, 4, seed + 2),
      seed + 3
    );
    
    const predictions: string[] = [];
    
    topicsToInclude.forEach((topic, index) => {
      const topicSentences = this.topics[topic];
      const sentence = this.seededChoice(topicSentences, seed + 4 + index);
      predictions.push(sentence);
    });
    
    const signSpecific = `Ваша ${trait} будет особенно полезна ${timeWord}, помогая преодолеть любые трудности на пути.`;
    predictions.push(signSpecific);
    
    const conclusion = this.seededChoice(this.conclusions, seed + 10);
    
    const shuffledPredictions = this.seededShuffle(predictions, seed + 11);
    
    const fullPrediction = shuffledPredictions.join(' ') + ' ' + conclusion;
    
    return fullPrediction;
  }
}